# Wordä¸Šä¼ è§£æåŠŸèƒ½è¯´æ˜ä¸æ›´æ­£æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**æ™‹æ–‡æºè¯•å·ç®¡ç†ç³»ç»Ÿ** çš„æ ¸å¿ƒåŠŸèƒ½ï¼šå°†Wordæ ¼å¼çš„è€ƒè¯•è¯•å·è‡ªåŠ¨è§£æä¸ºç»“æ„åŒ–é¢˜ç›®æ•°æ®ï¼Œæ”¯æŒåœ¨çº¿æ ¡å¯¹å’Œé¢˜åº“ç®¡ç†ã€‚

---

## ğŸ”„ å®Œæ•´è§£ææµç¨‹

### é˜¶æ®µ1: å‰ç«¯ä¸Šä¼ ï¼ˆmy-app/src/pages/PaperUpload/index.tsxï¼‰
```
ç”¨æˆ·æ“ä½œ
 â†“
ä¸Šä¼ .docxæ–‡ä»¶ + å¡«å†™å…ƒæ•°æ®ï¼ˆè¯•å·åã€å­¦ç§‘ã€å¹´ä»½ç­‰ï¼‰
 â†“
è°ƒç”¨API: POST /api/paper/upload
 â†“
è·å¾—taskIdï¼Œè·³è½¬åˆ°æ ¡å¯¹é¡µé¢
```

### é˜¶æ®µ2: åç«¯æ¥æ”¶ï¼ˆbackend/app/api/v1/paper.pyï¼‰
```
éªŒè¯æ–‡ä»¶æ ¼å¼å’Œå¤§å°
 â†“
ç”Ÿæˆä»»åŠ¡IDï¼ˆUUIDï¼‰
 â†“
ä¿å­˜æ–‡ä»¶åˆ°storage/uploads/
 â†“
å¯åŠ¨åå°è§£æä»»åŠ¡ï¼ˆBackgroundTasksï¼‰
 â†“
ç«‹å³è¿”å›{taskId}
```

### é˜¶æ®µ3: æ–‡æ¡£è§£æï¼ˆbackend/app/services/parse_service.pyï¼‰

**æ ¸å¿ƒç¼–æ’å™¨ ParseService åè°ƒ6ä¸ªä¸“ä¸šè§£æå™¨ï¼š**

#### 1ï¸âƒ£ DocxParser - æ–‡æ¡£åŠ è½½
- ä½¿ç”¨python-docxåŠ è½½Wordæ–‡æ¡£
- æå–æ®µè½å’Œè¡¨æ ¼

#### 2ï¸âƒ£ ImageParser - å›¾ç‰‡æå–
- ä»æ–‡æ¡£å…³ç³»ä¸­æå–æ‰€æœ‰å›¾ç‰‡
- ä¿å­˜åˆ°storage/images/{taskId}/
- ç”Ÿæˆè®¿é—®URL

#### 3ï¸âƒ£ StructureParser - ç»“æ„è¯†åˆ«â­
```python
è¯†åˆ«å†…å®¹ï¼š
- é¢˜å‹æ®µè½: "ä¸€ã€é€‰æ‹©é¢˜"
- ä¸»é¢˜å·: "1ï¼é¢˜å¹²"
- å°é¢˜å·: "(1) å°é¢˜"
- ææ–™å…³é”®è¯: "é˜…è¯»ä¸‹åˆ—ææ–™ï¼Œå®Œæˆä¸‹é¢å°é¢˜"

è¾“å‡ºï¼š
question_blocks = [
    {
        "number": "1",
        "type": "é€‰æ‹©é¢˜",
        "paragraphs": [æ®µè½åˆ—è¡¨],
        "is_material": False,
        "sub_questions": []
    },
    ...
]
```

#### 4ï¸âƒ£ ContentParser - å†…å®¹æå–â­
```python
è¯†åˆ«å±æ€§å—ï¼š
ã€ç­”æ¡ˆã€‘D
ã€éš¾åº¦ã€‘0.65
ã€çŸ¥è¯†ç‚¹ã€‘åŒ–å­¦ååº”ã€åŒ–å­¦å¹³è¡¡
ã€è¯¦è§£ã€‘/ã€è§£æã€‘è¯¦ç»†è§£é‡Š...

æå–é€‰é¡¹ï¼ˆé€‰æ‹©é¢˜ï¼‰ï¼š
Aï¼é€‰é¡¹A
Bï¼é€‰é¡¹B

è¾“å‡ºï¼š
{
    "stem": "é¢˜å¹²æ–‡æœ¬",
    "options": ["A. é€‰é¡¹A", "B. é€‰é¡¹B"],
    "answer": "D",
    "difficulty": 3,  # æ ‡å‡†åŒ–å
    "knowledge_points": ["åŒ–å­¦ååº”", "åŒ–å­¦å¹³è¡¡"],
    "analysis": "è¯¦ç»†è§£é‡Š"
}
```

#### 5ï¸âƒ£ FormulaParser - å…¬å¼è½¬æ¢
- æ£€æµ‹OMMLæ•°å­¦å…¬å¼
- è½¬æ¢ä¸ºMathMLæ ¼å¼
- åµŒå…¥HTML

#### 6ï¸âƒ£ TokenGenerator - HTMLç”Ÿæˆ
```python
Tokenæµï¼š
[æ–‡æœ¬] â†’ [å…¬å¼MathML] â†’ [å›¾ç‰‡img] â†’ [æ–‡æœ¬]
  â†“
HTMLè¾“å‡ºï¼š
<p>æ–‡æœ¬<math>...</math><img src="/api/..."/>...</p>
```

### é˜¶æ®µ4: å‰ç«¯æ ¡å¯¹ï¼ˆmy-app/src/pages/PaperUpload/Edit/index.tsxï¼‰
```
ä¸‰æ å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸä»¶é¢„è§ˆ  â”‚   é¢˜ç›®åˆ—è¡¨    â”‚ å±æ€§é¢æ¿  â”‚
â”‚         â”‚  [é¢˜1å¡ç‰‡]   â”‚  é¢˜å‹     â”‚
â”‚ (Mock)  â”‚  [é¢˜2å¡ç‰‡]   â”‚  éš¾åº¦â­â­â­â”‚
â”‚         â”‚  [é¢˜3å¡ç‰‡]   â”‚  çŸ¥è¯†ç‚¹   â”‚
â”‚         â”‚              â”‚  å¯Œæ–‡æœ¬   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŠŸèƒ½ï¼š
- ç‚¹å‡»é¢˜ç›®å¡ç‰‡ â†’ å³ä¾§æ˜¾ç¤ºè¯¦ç»†ç¼–è¾‘é¢æ¿
- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆwangEditorï¼‰ç¼–è¾‘é¢˜å¹²/ç­”æ¡ˆ/è§£æ
- ä¿®æ”¹é¢˜å‹ã€éš¾åº¦ã€çŸ¥è¯†ç‚¹
- å®æ—¶æ›´æ–°çŠ¶æ€
```

### é˜¶æ®µ5: æäº¤å…¥åº“ï¼ˆbackend/app/api/v1/paper.pyï¼‰
```
POST /api/paper/submit
 â†“
è°ƒç”¨QuestionService
 â†“
ä¿å­˜åˆ°PostgreSQLï¼š
- papersè¡¨ï¼ˆè¯•å·å…ƒæ•°æ®ï¼‰
- questionsè¡¨ï¼ˆé¢˜ç›®ä¸»è¡¨ï¼‰
- question_contentsè¡¨ï¼ˆå†…å®¹è¯¦æƒ…ï¼‰
- imagesè¡¨ï¼ˆå›¾ç‰‡å¼•ç”¨ï¼‰
```

---

## ğŸ” å®é™…Wordæ ¼å¼åˆ†æ

åŸºäº `2026å¹´1æœˆ16æ—¥åˆä¸­åŒ–å­¦ä½œä¸š.docx` åˆ†æå‘ç°ï¼š

### âœ… ä¸‰ç§é¢˜ç›®æ¨¡å¼

#### æ¨¡å¼1: å•é¢˜æ¨¡å¼ï¼ˆæœ€å¸¸è§ï¼‰
```
1ï¼é¢˜å¹²å†…å®¹
Aï¼é€‰é¡¹A
Bï¼é€‰é¡¹B
ã€ç­”æ¡ˆã€‘D
ã€éš¾åº¦ã€‘0.65
ã€çŸ¥è¯†ç‚¹ã€‘åŒ–å­¦ååº”ã€åŒ–å­¦å¹³è¡¡
ã€è¯¦è§£ã€‘è¯¦ç»†è§£é‡Š...
```

#### æ¨¡å¼2: é¢˜ç»„å½¢å¼ï¼ˆææ–™+å¤šé¢˜å…±äº«ç­”æ¡ˆï¼‰
```
é˜…è¯»ä¸‹åˆ—ææ–™ï¼Œå®Œæˆä¸‹é¢å°é¢˜
ææ–™å†…å®¹...

3ï¼é¢˜3é¢˜å¹²
Aï¼é€‰é¡¹...

4ï¼é¢˜4é¢˜å¹²
Aï¼é€‰é¡¹...

ã€ç­”æ¡ˆã€‘3ï¼B    4ï¼A
ã€éš¾åº¦ã€‘0.65
ã€çŸ¥è¯†ç‚¹ã€‘çŸ¥è¯†ç‚¹åˆ—è¡¨
ã€è§£æã€‘3ï¼è§£æ3å†…å®¹
4ï¼è§£æ4å†…å®¹
```

#### æ¨¡å¼3: ææ–™+å°é¢˜ï¼ˆç‹¬ç«‹å°é¢˜ç­”æ¡ˆï¼‰
```
7ï¼ä¸»é¢˜å¹²
(1)å°é¢˜1é¢˜å¹²
(2)å°é¢˜2é¢˜å¹²

ã€ç­”æ¡ˆã€‘(1)ç­”æ¡ˆ1
(2)ç­”æ¡ˆ2
ã€éš¾åº¦ã€‘0.85
ã€çŸ¥è¯†ç‚¹ã€‘çŸ¥è¯†ç‚¹åˆ—è¡¨
ã€è¯¦è§£ã€‘ï¼ˆ1ï¼‰è§£é‡Š1
ï¼ˆ2ï¼‰è§£é‡Š2
```

---

## âš ï¸ å‘ç°çš„é—®é¢˜

### é—®é¢˜1: ã€è¯¦è§£ã€‘æœªè¢«è¯†åˆ«
- **å½“å‰ä»£ç **: åªåŒ¹é… `ã€è§£æã€‘`
- **å®é™…æ–‡æ¡£**: å¤§é‡ä½¿ç”¨ `ã€è¯¦è§£ã€‘`
- **å½±å“**: è§£æä¸¢å¤±

### é—®é¢˜2: éš¾åº¦å€¼æ ¼å¼ä¸ç»Ÿä¸€
- **å®é™…æ ¼å¼**:
  - `ã€éš¾åº¦ã€‘0.65` ï¼ˆéš¾åº¦ç³»æ•°ï¼Œ0-1å°æ•°ï¼‰
  - `ã€éš¾åº¦ã€‘3` ï¼ˆéš¾åº¦ç­‰çº§ï¼Œ1-5æ•´æ•°ï¼‰
- **å½“å‰ä»£ç **: åªæ”¯æŒæ•´æ•°
- **å½±å“**: å°æ•°éš¾åº¦å€¼è§£æå¤±è´¥

### é—®é¢˜3: é¢˜ç»„ç­”æ¡ˆæ ¼å¼æœªæ”¯æŒ
- **å®é™…æ ¼å¼**: `ã€ç­”æ¡ˆã€‘3ï¼B    4ï¼A`
- **å½“å‰ä»£ç **: åªèƒ½æå–æ•´å—æ–‡æœ¬
- **å½±å“**: æ— æ³•åˆ†é…ç­”æ¡ˆåˆ°å„é¢˜

### é—®é¢˜4: å°é¢˜ç­”æ¡ˆæ ¼å¼æœªæ”¯æŒ
- **å®é™…æ ¼å¼**: `ã€ç­”æ¡ˆã€‘(1)ç­”æ¡ˆ1\n(2)ç­”æ¡ˆ2`
- **å½“å‰ä»£ç **: åªèƒ½æå–æ•´å—æ–‡æœ¬
- **å½±å“**: æ— æ³•åˆ†é…ç­”æ¡ˆåˆ°å„å°é¢˜

### é—®é¢˜5: ææ–™å…³é”®è¯ä¸å®Œæ•´
- **ç¼ºå°‘**: "å®Œæˆä¸‹é¢å°é¢˜"
- **å½±å“**: éƒ¨åˆ†ææ–™é¢˜è¯†åˆ«å¤±è´¥

### é—®é¢˜6: ä¸‰ç§æ¨¡å¼æœªåŒºåˆ†
- **å½“å‰ä»£ç **: åªç²—ç•¥åŒºåˆ†"å•é¢˜"å’Œ"ææ–™é¢˜"
- **å®é™…éœ€æ±‚**: åŒºåˆ†ä¸‰ç§ç²¾ç¡®æ¨¡å¼
- **å½±å“**: é¢˜ç»„ç­”æ¡ˆåˆ†é…é”™è¯¯

---

## âœ… è§£å†³æ–¹æ¡ˆ

### å·²åˆ›å»ºæ–‡æ¡£ï¼š
1. **WORD_FORMAT_ANALYSIS.md** - è¯¦ç»†æ ¼å¼åˆ†æ
2. **PARSING_UPDATES.md** - å®Œæ•´ä»£ç æ›´æ­£æ–¹æ¡ˆ

### æ ¸å¿ƒæ›´æ–°ï¼š

#### 1. ContentParserå¢å¼º
```python
class ContentParser:
    # æ”¯æŒã€è¯¦è§£ã€‘
    ANALYSIS_PATTERN = re.compile(r"ã€(?:è§£æ|è¯¦è§£)ã€‘\s*(.+?)")

    # æ”¯æŒå°æ•°éš¾åº¦
    DIFFICULTY_PATTERN = re.compile(r"ã€éš¾åº¦ã€‘\s*([\d.]+)")

    # é¢˜ç»„ç­”æ¡ˆè§£æ
    def parse_grouped_answers(self, text) -> Dict[str, str]:
        # "3ï¼B    4ï¼A" â†’ {"3": "B", "4": "A"}

    # å°é¢˜ç­”æ¡ˆè§£æ
    def parse_sub_answers(self, text) -> Dict[str, str]:
        # "(1)ç­”æ¡ˆ1\n(2)ç­”æ¡ˆ2" â†’ {"(1)": "ç­”æ¡ˆ1", "(2)": "ç­”æ¡ˆ2"}

    # éš¾åº¦æ ‡å‡†åŒ–
    def normalize_difficulty(self, value: float) -> int:
        # 0.65 â†’ 3, 0.85 â†’ 1, 3 â†’ 3
```

#### 2. æ¨¡å¼æ£€æµ‹ä¸å¤„ç†
```python
def extract_attributes(self, text, mode="single"):
    """
    modeå‚æ•°:
    - "single": å•é¢˜æ¨¡å¼
    - "grouped": é¢˜ç»„æ¨¡å¼
    - "sub": å°é¢˜æ¨¡å¼
    """
    if mode == "grouped":
        return self.parse_grouped_answers(answer_text)
    elif mode == "sub":
        return self.parse_sub_answers(answer_text)
    else:
        return answer_text
```

#### 3. ParseServiceæ™ºèƒ½åˆ†å‘
```python
def _process_material_question(self, block):
    # æ£€æŸ¥å­é¢˜æ ¼å¼
    first_sub_number = block["sub_questions"][0]["number"]

    if first_sub_number.startswith("("):
        # æ¨¡å¼3: ææ–™+å°é¢˜
        return self._process_sub_question_material(block)
    else:
        # æ¨¡å¼2: é¢˜ç»„å½¢å¼
        return self._process_question_group(block)
```

---

## ğŸ“Š å¯¹æ¯”è¡¨

| ç‰¹å¾ | æ¨¡å¼1 å•é¢˜ | æ¨¡å¼2 é¢˜ç»„ | æ¨¡å¼3 ææ–™+å°é¢˜ |
|------|----------|-----------|---------------|
| é¢˜å·æ ¼å¼ | 1, 2, 3 | 3, 4ï¼ˆè¿ç»­ï¼‰ | 7 + (1)(2) |
| ææ–™ | æ—  | æœ‰ | æœ‰ |
| ç­”æ¡ˆæ ¼å¼ | `ã€ç­”æ¡ˆã€‘D` | `ã€ç­”æ¡ˆã€‘3ï¼B 4ï¼A` | `ã€ç­”æ¡ˆã€‘(1)A (2)B` |
| æ•°æ®ç»“æ„ | å•ä¸ªQuestionItem | å¤šä¸ªç‹¬ç«‹QuestionItem | çˆ¶QuestionItem+children |

---

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### P0 é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰
- [x] æ”¯æŒã€è¯¦è§£ã€‘è¯†åˆ«
- [x] éš¾åº¦å€¼æ ‡å‡†åŒ–ï¼ˆ0.65 â†’ 3ï¼‰
- [x] é¢˜ç»„ç­”æ¡ˆè§£æ
- [x] å°é¢˜ç­”æ¡ˆè§£æ
- [x] æ›´æ–°ææ–™å…³é”®è¯

### P1 ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨å®Œæˆï¼‰
- [ ] å®ç°ä¸‰ç§æ¨¡å¼æ£€æµ‹
- [ ] æ›´æ–°ParseServiceåˆ†å‘é€»è¾‘
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] çœŸå®æ–‡æ¡£ç«¯åˆ°ç«¯æµ‹è¯•

### P2 ä½ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–ï¼‰
- [ ] é”™è¯¯æ¢å¤æœºåˆ¶
- [ ] è§£ææ—¥å¿—å¢å¼º
- [ ] å‰ç«¯å±•ç¤ºä¼˜åŒ–

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### åç«¯æ ¸å¿ƒæ–‡ä»¶
```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/v1/paper.py               # APIç«¯ç‚¹
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”‚   â”œâ”€â”€ docx_parser.py        # æ–‡æ¡£åŠ è½½
â”‚   â”‚   â”‚   â”œâ”€â”€ structure_parser.py   # â­ç»“æ„è¯†åˆ«
â”‚   â”‚   â”‚   â”œâ”€â”€ content_parser.py     # â­å†…å®¹æå–
â”‚   â”‚   â”‚   â”œâ”€â”€ formula_parser.py     # å…¬å¼è½¬æ¢
â”‚   â”‚   â”‚   â”œâ”€â”€ image_parser.py       # å›¾ç‰‡æå–
â”‚   â”‚   â”‚   â””â”€â”€ token_generator.py    # HTMLç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ task_manager.py           # ä»»åŠ¡ç®¡ç†
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ parse_service.py          # â­è§£æç¼–æ’
â”œâ”€â”€ WORD_FORMAT_ANALYSIS.md           # æ ¼å¼åˆ†ææ–‡æ¡£
â””â”€â”€ PARSING_UPDATES.md                # æ›´æ–°æ–¹æ¡ˆæ–‡æ¡£
```

### å‰ç«¯æ ¸å¿ƒæ–‡ä»¶
```
my-app/
â””â”€â”€ src/
    â”œâ”€â”€ pages/
    â”‚   â””â”€â”€ PaperUpload/
    â”‚       â”œâ”€â”€ index.tsx              # ä¸Šä¼ é¡µé¢
    â”‚       â””â”€â”€ Edit/
    â”‚           â”œâ”€â”€ index.tsx          # æ ¡å¯¹é¡µé¢
    â”‚           â”œâ”€â”€ QuestionCard.tsx   # é¢˜ç›®å¡ç‰‡
    â”‚           â””â”€â”€ AttributePanel.tsx # ç¼–è¾‘é¢æ¿
    â””â”€â”€ services/
        â””â”€â”€ paperUpload.ts             # APIè°ƒç”¨
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. å•å…ƒæµ‹è¯•
```bash
cd backend
pytest tests/test_content_parser.py -v
```

### 2. çœŸå®æ–‡æ¡£æµ‹è¯•
```bash
# ä¸Šä¼ æµ‹è¯•æ–‡æ¡£
curl -X POST http://localhost:8000/api/paper/upload \
  -F "file=@/path/to/test.docx" \
  -F "metadata={...}"

# æŸ¥çœ‹è§£æç»“æœ
curl http://localhost:8000/api/paper/result/{taskId}
```

### 3. å‰ç«¯é›†æˆæµ‹è¯•
```bash
cd my-app
npm run dev

# è®¿é—® http://localhost:8000/question-bank/word-upload
# ä¸Šä¼ æ–‡æ¡£å¹¶éªŒè¯è§£æç»“æœ
```

---

## ğŸ“ åç»­æ”¯æŒ

è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£å·²åˆ›å»ºï¼š
- `backend/WORD_FORMAT_ANALYSIS.md` - æ ¼å¼åˆ†æ
- `backend/PARSING_UPDATES.md` - ä»£ç æ›´æ–°æ–¹æ¡ˆ

å¦‚éœ€å®æ–½ä»£ç æ›´æ–°ï¼Œè¯·å‚è€ƒ `PARSING_UPDATES.md` ä¸­çš„è¯¦ç»†ä»£ç ã€‚
