# 试题打标功能设计方案

**日期**: 2026-01-22
**功能**: 晋文源题库 - 试题打标
**类型**: 前端原型实现

## 功能概述

在晋文源题库下新增"试题打标"菜单，用于对已录入系统的试题进行批量标签标注。这是一个独立的标注工具，支持单个试题打标和批量打标两种模式。

## 核心需求

- **功能定位**: 批量标注工具，用于给已有试题打标签
- **标注工作流**: 混合模式，同时支持逐个标注和批量标注
- **标注内容**: 知识点、题型、难度、教材章节
- **试题来源**: 所有试题，支持条件筛选
- **筛选条件**: 科目、试卷、标签状态、关键词搜索
- **页面布局**: 左中右三栏布局
- **实现范围**: 仅前端原型，使用 Mock 数据

## 整体架构

### 路由配置

在 `config/routes.ts` 中的"晋文源题库"菜单下新增路由：

```typescript
{
  path: '/question-bank/tagging',
  name: '试题打标',
  icon: 'TagsOutlined',
  component: './QuestionTagging',
}
```

### 页面结构

创建新页面 `src/pages/QuestionTagging/index.tsx`，采用左中右三栏布局：
- 使用 Ant Design 的 `Layout` 组件
- **左侧栏**：固定宽度（300-350px），试题列表
- **中间栏**：自适应宽度，试题详情展示
- **右侧栏**：固定宽度（350-400px），标签表单

### 组件拆分

```
QuestionTagging/
├── index.tsx              # 主页面，管理整体布局和状态
├── components/
│   ├── FilterPanel.tsx    # 筛选条件面板（左侧顶部）
│   ├── QuestionList.tsx   # 试题列表（左侧，缩略显示）
│   ├── QuestionDetail.tsx # 试题详情（中间，完整展示）
│   └── TaggingForm.tsx    # 标签表单（右侧）
├── services.ts            # API 服务（使用 mock 数据）
└── mockData.ts            # Mock 数据
```

### 状态管理

使用 React Hooks 管理状态：
- `currentQuestionId`: 当前查看的试题 ID（单选模式）
- `selectedQuestionIds`: 选中的试题 ID 列表（批量模式）
- `currentQuestion`: 当前查看的试题详情
- `filters`: 筛选条件
- `questionList`: 试题列表数据
- `pagination`: 分页信息
- `isBatchMode`: 是否为批量模式（根据 selectedQuestionIds 长度判断）

## 详细设计

### 1. 筛选面板 (FilterPanel.tsx)

位于左侧栏顶部，筛选条件包含四个部分：

1. **科目筛选**: 下拉选择框（Select），从科目列表中选择
2. **试卷筛选**: 级联选择器（Cascader），先选科目再选具体试卷
3. **标签状态**: 单选按钮组（Radio.Group）
   - 全部
   - 已完整打标（所有标签都有）
   - 部分打标（至少有一个标签）
   - 未打标（所有标签都为空）
4. **关键词搜索**: 搜索框（Input.Search），支持搜索题干内容

布局采用紧凑的垂直布局，每个筛选项占一行。

### 2. 试题列表 (QuestionList.tsx)

位于左侧栏，筛选面板下方。

**列表项设计**

- 使用 `List` 组件展示试题，垂直排列
- 每个列表项包含：
  - **复选框**（用于批量选择）
  - **题号** + **题型标签**（Tag）+ **标签状态图标**（右上角）
  - **题干缩略**：显示前100字，超出部分用省略号
  - **已有标签预览**：底部用小号 Tag 展示已打的标签
- 点击列表项：
  - 高亮选中（蓝色边框或背景色）
  - 中间栏显示完整试题详情
  - 右侧栏显示标签表单
- 当前选中项始终保持高亮状态

**批量选择**

- 顶部显示"全选"复选框
- 选中多个试题时，顶部显示工具栏：
  - "已选择 X 道试题"
  - "取消选择"按钮
- 选中多个试题时，右侧表单切换为批量打标模式

**快捷导航**

- 支持键盘上下键快速切换试题
- 支持 ⌘+↑/↓ 跳转到上一题/下一题

**分页**

底部使用 `Pagination` 组件，每页显示 15-20 条

### 3. 试题详情 (QuestionDetail.tsx)

位于中间栏，根据选择状态显示不同内容。

#### 单选模式（选中1道试题）

**内容结构**

- **顶部**: 题号 + 题型标签 + 来源试卷信息
- **题干区**: 完整题干内容（支持富文本、图片、公式渲染）
- **选项区**: 如果有选项，完整展示所有选项
- **答案区**: 可折叠展示答案（Collapse 组件）
- **解析区**: 可折叠展示解析（Collapse 组件）
- **底部导航**:
  - "上一题"按钮（←）
  - "下一题"按钮（→）
  - 快捷键提示

**交互**

- 支持键盘快捷键：
  - ← 或 ⌘+← : 上一题
  - → 或 ⌘+→ : 下一题
  - ⌘+Enter : 保存并下一题

#### 批量模式（选中多道试题）

**内容结构**

- **顶部提示**: "已选择 X 道试题"
- **试题列表**: 显示所有选中试题的缩略信息
  - 题号 + 题干前50字
  - 垂直排列，可滚动
- **提示文字**: "请在右侧表单中设置批量标签"

### 4. 标签表单 (TaggingForm.tsx)

位于右侧栏，用于对试题进行标注。根据选择状态显示不同模式。

#### 模式一：单个试题标注（选中1道试题）

**表单结构**

- **知识点**: 树形选择器（TreeSelect），支持多选，从知识点树中选择
- **题型**: 下拉单选（Select），从题型列表中选择
- **难度**: 单选按钮组（Radio.Group）- 简单/中等/困难
- **教材章节**: 级联选择器（Cascader），支持多选

**自动保存**

- 修改任意字段后延迟 500ms 自动保存
- 显示保存状态：保存中（Spin）/ 已保存（✓）/ 保存失败（✗）

**快捷操作**

- **"保存并下一题"按钮**（⌘+Enter）：保存当前标签并跳转到下一题
- **"跳过"按钮**：不保存，直接跳转到下一题
- **快捷键提示**：底部显示常用快捷键

#### 模式二：批量打标（选中多道试题）

**顶部提示**
- 显示："正在为 X 道试题批量打标"

**表单结构**

每个字段包含：
1. **Switch 开关**（默认关闭）
2. **字段输入控件**（开关关闭时禁用）

具体字段：
- **知识点**: Switch + 树形选择器（TreeSelect），多选
- **题型**: Switch + 下拉选择（Select），单选
- **难度**: Switch + 单选按钮组（Radio.Group）
- **教材章节**: Switch + 级联选择器（Cascader），多选

**交互逻辑**

- Switch 默认关闭，输入控件为禁用状态（灰色）
- 打开 Switch 后，输入控件激活，可以选择新值
- 只有 Switch 打开的字段才会被批量应用
- 应用时，新值会**完全覆盖**所有选中试题的原有值
- 未打开 Switch 的字段保持原样，不做任何修改

**底部操作**

- **"应用到所有选中试题"按钮**：批量保存所有开启的字段
- **"取消"按钮**：取消批量操作，返回单选模式

**未选中状态**

- 显示提示信息："请从左侧选择试题进行打标"
- 显示快捷键操作指引

## 数据结构

### 试题数据结构

```typescript
interface Question {
  id: string;
  number: string;           // 题号
  type: string;             // 题型
  stem: string;             // 题干（HTML）
  options?: string[];       // 选项
  answer?: string;          // 答案
  analysis?: string;        // 解析
  paperId?: string;         // 所属试卷ID
  paperName?: string;       // 试卷名称
  subject: string;          // 科目

  // 标签信息
  knowledgePoints?: string[];  // 知识点ID数组
  questionType?: string;       // 题型ID
  difficulty?: 'easy' | 'medium' | 'hard';
  chapters?: string[];         // 教材章节ID数组

  // 标签状态
  tagStatus: 'untagged' | 'partial' | 'complete';
}
```

### 筛选条件

```typescript
interface FilterParams {
  subject?: string;
  paperId?: string;
  tagStatus?: 'all' | 'complete' | 'partial' | 'untagged';
  keyword?: string;
  page: number;
  pageSize: number;
}
```

## 交互流程

### 1. 页面初始化
- 加载筛选条件的选项数据（科目列表、试卷列表、知识点树、题型列表等）
- 默认加载第一页试题列表
- 默认选中第一道试题，中间和右侧显示其详情和标签表单

### 2. 筛选操作
- 用户修改筛选条件 → 触发查询 → 重新加载试题列表 → 重置分页到第1页 → 自动选中第一道试题

### 3. 选择试题
- 点击列表项 → 高亮该项 → 中间栏显示完整试题详情 → 右侧栏显示标签表单（回显已有标签）
- 支持键盘上下键快速切换试题

### 4. 标注操作
- 修改表单任意字段 → 延迟 500ms 自动保存 → 显示保存状态 → 更新列表中的标签状态图标
- 点击"保存并下一题" → 立即保存 → 跳转到下一题
- 点击"跳过" → 不保存，直接跳转到下一题

### 5. 导航操作
- 点击"上一题"/"下一题"按钮 → 切换试题
- 使用键盘快捷键（←/→）→ 快速切换试题
- 使用 ⌘+Enter → 保存并下一题

## 实现细节

### Mock 数据准备

在 `src/pages/QuestionTagging/mockData.ts` 中准备：
- Mock 试题列表（10-20条示例数据）
- Mock 科目列表
- Mock 试卷列表
- Mock 知识点树
- Mock 题型树
- Mock 教材章节树

### 关键实现要点

**1. 自动保存防抖**
- 使用 `lodash.debounce` 或自定义 hook
- 表单修改后延迟 500ms 自动保存
- 避免频繁触发保存请求

**2. 富文本渲染**
- 题干、选项、答案、解析都可能包含 HTML
- 使用 `dangerouslySetInnerHTML` 或安全的 HTML 渲染组件
- 支持图片、公式的正常显示

**3. 状态同步**
- 保存成功后，更新列表中对应试题的标签状态
- 使用 `useState` + `useEffect` 管理状态同步

**4. 键盘快捷键**
- 使用 `useEffect` 监听键盘事件
- 支持上下键切换试题
- 支持左右键导航
- 支持 ⌘+Enter 保存并下一题

**5. 用户体验优化**
- 保存时显示 loading 状态
- 保存成功显示 `message.success`
- 保存失败显示 `message.error` 并允许重试

**6. 样式建议**
- 左侧宽度：300-350px
- 中间宽度：自适应
- 右侧宽度：350-400px
- 列表项间距：8px
- 选中列表项：蓝色边框或背景色高亮
- 标签状态图标：使用不同颜色区分（绿色=完整，橙色=部分，灰色=未打标）

## 开发顺序

1. 添加路由配置
2. 创建页面框架和三栏布局
3. 编写 Mock 数据
4. 实现筛选面板组件
5. 实现试题列表组件
6. 实现试题详情组件
7. 实现标签表单组件
8. 集成所有组件并实现状态管理
9. 实现键盘快捷键
10. 优化交互和样式

## 技术栈

- **框架**: Umi Max 4 + React
- **UI 组件**: Ant Design + Ant Design Pro Components
- **状态管理**: React Hooks (useState, useEffect)
- **数据**: Mock 数据（前端原型）

## 后续扩展

当需要对接后端时，只需：
1. 将 mock 数据替换为真实 API 调用
2. 在 `services.ts` 中实现真实的 API 请求
3. 处理 loading 和 error 状态
4. 添加错误处理和重试机制
