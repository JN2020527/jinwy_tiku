# 智慧助教平台 - Word试卷解析上传功能需求文档

**文档编号:** PRD-20260112-001
**版本号:** V1.0
**状态:** 草稿 (Draft)
**创建日期:** 2026-01-12
**拟稿人:** 产品经理 (AI Agent)
**对应项目:** 题库系统建设 / 数据底座优化

---

## 1. 背景与目的 (Background & Goals)

### 1.1 背景
当前平台题库数据的录入主要依赖“OCR试卷识别”路径。虽然OCR实现了纸质/PDF试卷的数字化，但在实际运行中，内部教研编辑团队反馈存在以下痛点：
1.  **校对成本高**：OCR对公式、复杂版式的识别率存在波动，人工校对修改耗时较长。
2.  **流程繁琐**：对于已有Word电子版的试卷，仍需经过"转PDF -> OCR识别 -> 校对"的流程，属于反向低效作业。
3.  **编辑体验差**：现有系统对图文混排、公式编辑的支持不够灵活，无法直接复制粘贴富文本内容。

### 1.2 目的
构建“Word试卷解析上传”功能，开辟第二条数据录入快车道。
*   **提效**：直接利用存量Word试卷资源，跳过OCR识别环节，大幅降低校对工作量。
*   **兼容**：支持“试卷录入”与“试题录入”两种核心模式。
*   **易用**：提供所见即所得的编辑体验，支持图片/公式的便捷处理。

---

## 2. 用户角色与场景 (User Roles & Scenarios)

| 用户角色 | 典型场景 | 核心诉求 |
| :--- | :--- | :--- |
| **教研编辑** | 拿到一份排版良好的Word期末试卷，需要快速入库。 | 解析准确，少改动；公式不乱码；图片位置对。 |
| **教研组长** | 整理某学科的“函数专题”习题集（Word文档），包含20道题。 | 单个文件上传，自动拆题；能快速检查入库质量。 |
| **兼职录入** | 对解析结果中的错别字进行修改，补充缺失的图片。 | 编辑器好用，支持截图直接粘贴。 |

---

## 3. 功能需求详述 (Functional Requirements)

### 3.1 核心流程
1.  **文件上传** -> 2. **智能解析** -> 3. **人工校对/编辑** -> 4. **入库审核**

### 3.2 模块细分

#### F1. 文件上传模块 (File Upload)
*   **支持格式**：主要支持 `.docx` (Office Open XML)，兼容 `.doc` (若技术可行)。
*   **上传方式**：
    *   每次仅支持**单个文件**上传。
    *   支持拖拽上传。
*   **元数据配置 (Metadata)**：上传后根据模式要求填写基础信息：
    *   **试卷录入模式**：
        *   **试卷名称**：必填（默认取文件名，支持编辑）。
        *   **核心属性**：年份、学段、学科、地区、试卷类型（真题/模拟卷等）。
        *   **作用**：所有解析出的试题将自动继承上述属性作为其“来源”标签。
    *   **试题录入模式**：
        *   **核心属性**：学科（必填）、学段（选填）。
        *   **忽略项**：无需填写试卷名称、年份、地区等试卷级信息。
        *   **作用**：仅作为入库试题的分类依据。
*   **解析模式选择**：
    *   **试卷录入 (Paper Entry)**：以“完整试卷”为单位。保留试卷标题、分卷结构及题号，生成试卷ID并关联试题。适用于历年真题、全真模拟卷。
    *   **试题录入 (Question Entry)**：以“独立试题”为单位。不创建试卷，仅解析题目内容。系统自动尝试按题号拆题（支持单题或多题文档）。适用于专题练习、日常补题。

#### F2. 智能解析引擎 (Parsing Engine)
*   **结构识别逻辑 (核心)**：
    1.  **分层扫描 (属性预设)**：
        *   **题型容器识别**：扫描“一、XX题”等关键字，仅用于**自动判定并预设**后续题目的“题型属性”，**不自动生成**编辑器内的可视化卡片（以确保解析结果的纯净度）。
        *   **题目切分识别**：以“1.”、“2.”等数字作为物理分割锚点，生成独立的试题卡片。
    2.  **模式自动判定**：
        *   **纯题干模式**：当检测到 `题号 N` 与 `题号 N+1` 之间仅包含题目文本和选项时，识别为单题。
        *   **材料模式**：当检测到 `题号 N` 之前存在大量无题号文本（且非卷头），或题号之间包含“Passage/材料”关键词时，自动将该文本识别为“公共材料”，并将后续题目关联为子题。
    3.  **内容切分与属性提取 (核心逻辑)**：
        *   **过滤规则**：强制忽略页眉、页脚内容，不作为试卷属性录入。
        *   **多锚点截断机制**：建立“属性标签集合”（如：【答案】、【解析】、【考点】、【分数】等）。
        *   **题干截断判定**：题干内容的结束点 = **“标签集合中任意一个标签的首次出现位置”** 或 **“下一题题号位置”**（取两者中较靠前的一个）。
        *   **属性分段逻辑**：截断题干后，系统进入“属性提取模式”。采用**“遇标切分”**原则：
            *   识别到某标签（如`【答案】`）开始录入该字段内容，直到遇到**下一个标签**（如`【解析】`）或**下一题题号**为止。
            *   **支持多标签并存**：无论标签顺序如何（如答案在前解析在后，或反之），均可独立提取对应内容，互不干扰。
        *   **解析示例演示**：
            *   *原始文本*：`1. 题目内容... 【答案】B 【解析】解析内容...`
            *   *第一步（切题干）*：从题号扫描至第一个标签`【答案】`，将之前内容存入“题干”字段。
            *   *第二步（切答案）*：从标签`【答案】`开始扫描，遇到下一个标签`【解析】`即停止，中间内容存入“答案”。
            *   *第三步（切解析）*：从标签`【解析】`开始扫描，直到遇到下一题题号或文档结束，中间内容存入“解析”。
        *   **位置约定**：根据 SOP 规范，解析引擎仅识别题目下方的答案/解析块，不处理文档末尾汇总的答案。
*   **内容提取能力**：
    *   **输出格式**：解析结果统一输出为 **结构化 HTML**，以适配现有题库底座存储标准。
    *   **文本**：
        *   **样式清洗 (Developer Friendly)**：解析时强制剥离所有非语义化样式。
            *   **禁止项 (Strip)**：`font-family`, `font-size`, `line-height`, `color`, `background-color`, `text-align` (题目级别除外) 等 CSS 属性。
            *   **保留项 (Keep)**：语义化标签如 `<b>`/`<strong>` (加粗), `<i>`/`<em>` (斜体), `<u>` (下划线), `<sup>` (上标), `<sub>` (下标)。
        *   **输出格式**：统一输出为符合系统标准的结构化 HTML。
    *   **图片**：自动提取文档内“嵌入型”图片，上传云存储并替换为 `<img>` 标签。对于“浮动型”图片尝试自动转换为嵌入型或报错提示。
    *   **公式**：
        *   原生支持 Office MathML (OMML) 解析并转换为 HTML/MathML 渲染。
        *   支持将公式块封装为特定 `<div>` 或插入 LaTeX 标签。
        *   **兜底策略**：无法解析的复杂公式、图文混排区域，自动裁剪为图片处理，以图片标签形式嵌入 HTML。
    *   **表格**：
        *   **默认策略**：保留表格结构，解析为 HTML `<table>` 标签，支持基础内容编辑。
        *   **异常处理**：对于解析效果不佳的复杂表格（如嵌套、跨页），建议在操作手册中引导用户在 Word 原件中将其转换为图片后重新上传。
*   **异常处理与容错机制**：
    *   **解析失败阻断 (第一层级：结构性崩塌)**：
        *   **触发条件**：若系统无法检测到连续题号结构（识别题目数量 < 3 且无明显题型标题），或文档为空。
        *   **处理动作**：直接中止流程，跳转至“解析失败”页。
        *   **用户引导**：明确展示失败原因（如：“未识别到标准题号结构 1. 2.”），提供《标准录入模版》下载链接，引导用户修改 Word 原件。
    *   **格式预警**：检测到双栏排版、浮动图片或公式解析置信度低时，在解析报告中标记“可能异常”，并于编辑器内高亮对应题目。

#### F3. 在线校对编辑器 (Verification Editor)
*   **技术选型建议**：前端建议采用 **Tiptap (React)** 无头编辑器架构，利用其 Schema 机制在前端实现二次格式过滤。
*   **布局设计 (Triple-Column Layout)**：为了兼顾校对与标引效率，强制采用**三栏式布局**。
    *   **左侧 (Source - 30%)**：**原件预览区**。显示 Word/PDF 原视图，作为校对基准。
    *   **中间 (Target - 45%)**：**校对编辑区**。显示解析后的题目卡片流。
        *   **选中态**：点击某张卡片，该卡片获得高亮边框。
    *   **右侧 (Attributes - 25%)**：**属性标引面板 (Side Panel)**。
        *   **联动交互**：右侧面板内容实时跟随中间栏“当前选中题”切换。
        *   **属性集合**：
            *   **题型**：系统根据解析结果预设（如单选/填空），支持人工修改。
            *   **知识点**：采用“级联选择器”或“树形下拉框”，支持快速搜索。
            *   **难度系数**：支持 1-5 星级设置。
            *   **核心素养**：勾选框列表。
*   **交互效率优化**：
    *   **属性记忆/推荐**：在右侧面板顶部展示“最近使用知识点”，支持一键快速打标。
    *   **批量打标 (Batch Operation)**：
        *   **多选机制**：试题卡片左上角提供**复选框 (Checkbox)**，支持 `Ctrl+Click` 点选和 `Shift+Click` 范围连选。
        *   **批量覆写**：选中多道题目后，右侧面板自动进入“批量编辑模式”（显示如“已选中 5 道题”）。此时修改知识点或难度，将**一次性应用**至所有选中题目。
    *   **键盘快捷键**：支持使用 `↑`/`↓` 键快速切换题目，并在切换时自动保存已填写的属性。
    *   **试题卡片设计 (Header-Body-Footer 结构)**：
        *   **标准试题卡片**：
            *   **顶部 (Info Header)**：信息标签栏。展示题号、题型、属性标签。
            *   **中部 (Content Body)**：内容展示区。展示题干、答案及解析。
            *   **底部 (Action Footer)**：功能操作栏。
        *   **辅助文本卡片 (Instructional Text Card)**：
            *   **定义**：用于补充“大题标题”（如“一、选择题”）、“分卷说明”或“注意事项”等非试题内容。
            *   **来源**：**不依赖解析引擎自动生成**（解析时自动过滤非试题文本），仅支持用户在编辑器内**手动插入**。
            *   **形态**：简化版卡片，仅包含一个富文本展示/编辑区，无属性标签和答案槽位。
            *   **操作**：支持编辑、删除及上下拖拽排序。
    *   **底部功能操作栏 (Action Footer)**：平铺显示核心操作按钮：
        *   `[ ✏️ 编辑内容 ]`（点击唤起弹窗）
        *   `[ 🗑️ 删除 ]`
        *   `[ ✂️ 拆分/合并 ]`
        *   `[ 🔄 替换 ]`
        *   `[ ➕ 插入... ]` -> 展开菜单：`[ 插入新题 ]` / `[ 插入辅助文本 ]`

#### F4. 预览与入库 (Preview & Commit)
*   **查重机制 (Duplicate Detection)**：
    *   **MD5/标题校验**：上传时自动检测库中是否存在高相似度试卷。
    *   **反馈**：若命中重复，提示“库内已存在类似试卷”，允许用户选择“强制覆盖”或“查看原卷”。
*   提供“整卷预览”视图，模拟学生端/教师端查看效果。
*   数据校验：
    *   必填项检查（题干、答案不能为空）。
    *   格式检查（选择题选项数量是否合法）。
*   一键入库/保存草稿。

---

## 4. 扩展场景支持 (Extensions)

### 4.1 英语听力音频挂载 (Audio Attachment)
*   **上传逻辑**：在“试卷录入模式”下，支持上传关联的 MP3/Zip 音频文件。
*   **解析挂载**：在校对编辑器中，支持将音频片段关联至“听力大题”或具体的“小题”上。

---

## 附录：标准录入模版规范 (Template Specification)

为确保解析准确率，建议编辑团队遵循以下 Word 录入规范：

### 1. 版式要求
*   **单栏排版**：避免使用双栏或多栏布局。
*   **清除干扰**：删除无关的页眉、页脚、水印及背景装饰。
*   **图片嵌入**：图片环绕方式必须设置为“**嵌入型**”。

### 2. 结构标识 (锚点)

*   **题型 (Section)**：使用“一、”、“二、”等汉字数字开头（如：一、选择题）。

*   **两大核心录入场景规范**：

    *   **场景 A：纯题干模式 (Standalone Mode)**
        *   **定义**：题目独立存在，无公共材料。
        *   **规范**：【题号】+【题干/选项】+【内容标记】。
        *   **示例**：`1. 2026的相反数是（  ） A. 2026 B. -2026 ... 【答案】B`

    *   **场景 B：材料 + 小题模式 (Context + Sub-questions Mode)**
        *   **定义**：多道题目共用一段背景材料（一材多题）。
        *   **规范**：【公共材料】+【小题1】+【小题2】...。
        *   **识别逻辑**：系统自动将题号之前的文本识别为“公共材料”，将后续连续的题号识别为关联的小题。
        *   **示例**：`阅读下列材料，回答4-5题：[材料内容]... 4. 题目内容... 【答案】 5. 题目内容... 【答案】`

*   **符号规范 (锚点强制要求)**：
    *   **主序号**：建议使用“1.”、“2.”等阿拉伯数字。
    *   **子序号**：支持“(1)”、“①”等格式，用于解答题的小问拆分。
    *   **属性标签**：包括 **【答案】**、**【解析】**、**【考点】** 等。
    *   **核心要求**：
        1. 任何属性标签（如【答案】或【解析】）的出现均会被系统判定为题干部分的结束。
        2. **强制要求所有标签内容必须跟随在对应题目下方**，禁止在文档末尾汇总录入，亦不支持多题批量录入（如：1-5 BACDA）。
        3. 【答案】通常为必填项（入库校验逻辑），【解析】/【考点】为选填。

### 3. 内容录入规范示例 (Gold Standard)

以下示例展示了两种核心模式在 Word 中的标准排版，请直接参考。

#### 示例 A：纯题干模式 (常规选择题/填空题)
*适用于数学、物理单选题，或无背景材料的散题。*

```text
一、选择题

1. 下列图形中，是中心对称图形的是（    ）
A. 等边三角形    B. 平行四边形
C. 等腰三角形    D. 直角三角形
【答案】B
【解析】平行四边形绕对角线交点旋转180度能与自身重合。

2. 计算 |-5| 的结果是（    ）
A. 5    B. -5    C. 0    D. 1/5
【答案】A
```

#### 示例 B：材料 + 小题模式 (一材多题)
*适用于英语阅读理解、政史地材料题、语文现代文阅读。*

```text
二、阅读理解

（场景1：英语阅读 - 文章 + 题组）
Passage A
Last Sunday, Tom went to the park with his dog. They played happily under the big tree... (此处为文章内容)... Suddenly, it began to rain.

21. Who did Tom go to the park with?
A. His father.    B. His mother.
C. His dog.       D. His cat.
【答案】C

22. What happened suddenly?
A. It snowed.     B. It rained.
C. The dog ran away.  D. Tom fell down.
【答案】B
【解析】根据文中最后一句 Suddenly, it began to rain 可知。

（场景2：历史材料题 - 材料 + 综合问答）
15. 阅读下列材料，回答问题。
材料一：2025年，山西省文旅产业迎来爆发式增长...
材料二：太原古县城举办了盛大的灯光秀...

(1) 材料一反映了什么经济现象？
【答案】反映了第三产业（旅游业）的蓬勃发展。

(2) 结合材料二，谈谈如何保护古建筑？
【答案】坚持保护第一、修旧如旧的原则；合理开发利用。
```

#### 4. 通用排版禁忌
*   **禁止双栏**：必须将页面设置为“一栏”。
*   **禁止悬浮图片**：所有图片必须设置为 **“嵌入型”**。
*   **禁止文本框公式**：严禁使用文本框拼凑公式，亦不建议使用第三方过时插件（如旧版 MathType）。
*   **强制公式规范**：公式必须使用 **Word 原生公式编辑器 (Office Math/OMML)** 进行录入。
    *   *原因*：原生公式可被系统 100% 结构化解析为 LaTeX/MathML，确保在学生端渲染时不模糊、可缩放且支持全文检索。
    *   *检测*：系统解析时若发现以图片形式存在的公式，将标记为“低质量数据”，需人工二次转录。
*   **禁止尾部汇总答案**：严禁将全卷答案集中附在文档末尾，必须剪切至对应题目下方。